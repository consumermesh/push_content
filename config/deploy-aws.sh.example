#!/bin/bash

# AWS S3 + CloudFront deployment script
# Usage: deploy-aws.sh -o <org> -n <name> --bucket <bucket> [--region <region>] [--cloudfront-distribution-id <distribution_id>]

set -e  # Exit on error
set -u  # Exit on undefined variable

# Default values
ORG=""
NAME=""
BUCKET=""
REGION="us-east-1"
CLOUDFRONT_DISTRIBUTION_ID=""
PURGE_CLOUDFRONT=true
SYNC_OPTIONS="--delete --exact-timestamps"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -o)
      ORG="$2"
      shift 2
      ;;
    -n)
      NAME="$2"
      shift 2
      ;;
    --bucket)
      BUCKET="$2"
      shift 2
      ;;
    --region)
      REGION="$2"
      shift 2
      ;;
    --cloudfront-distribution-id)
      CLOUDFRONT_DISTRIBUTION_ID="$2"
      shift 2
      ;;
    --no-cloudfront-purge)
      PURGE_CLOUDFRONT=false
      shift
      ;;
    --dry-run)
      SYNC_OPTIONS="$SYNC_OPTIONS --dry-run"
      shift
      ;;
    -h|--help)
      echo "Usage: $0 -o <org> -n <name> --bucket <bucket> [--region <region>] [--cloudfront-distribution-id <distribution_id>] [--no-cloudfront-purge] [--dry-run]"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Validate required parameters
if [[ -z "$ORG" ]] || [[ -z "$NAME" ]] || [[ -z "$BUCKET" ]]; then
  echo "Error: Missing required parameters"
  echo "Usage: $0 -o <org> -n <name> --bucket <bucket>"
  exit 1
fi

# Check AWS credentials
if [[ -z "${AWS_ACCESS_KEY_ID:-}" ]] || [[ -z "${AWS_SECRET_ACCESS_KEY:-}" ]]; then
  echo "Error: AWS credentials not configured"
  echo "Please set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environment variables"
  exit 1
fi

echo "=== AWS Deployment Started ==="
echo "Organization: $ORG"
echo "Name: $NAME"
echo "S3 Bucket: $BUCKET"
echo "AWS Region: $REGION"
echo "CloudFront Distribution: ${CLOUDFRONT_DISTRIBUTION_ID:-None}"
echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

# Build paths
BUILD_DIR="/opt/cmesh/builds/$ORG/$NAME"
DIST_DIR="$BUILD_DIR/dist"

# Check if build directory exists
if [[ ! -d "$BUILD_DIR" ]]; then
  echo "Error: Build directory not found: $BUILD_DIR"
  exit 1
fi

# Check if dist directory exists
if [[ ! -d "$DIST_DIR" ]]; then
  echo "Error: Dist directory not found: $DIST_DIR"
  exit 1
fi

echo "Build directory: $BUILD_DIR"
echo "Dist directory: $DIST_DIR"
echo ""

# Check if AWS CLI is installed
if ! command -v aws &> /dev/null; then
  echo "Error: AWS CLI is not installed"
  exit 1
fi

# Verify AWS credentials work
echo "Verifying AWS credentials..."
if ! aws sts get-caller-identity --region "$REGION" &>/dev/null; then
  echo "Error: AWS credentials are invalid or don't have necessary permissions"
  exit 1
fi
echo "✓ AWS credentials verified"
echo ""

# Check if S3 bucket exists
echo "Checking S3 bucket: $BUCKET"
if ! aws s3api head-bucket --bucket "$BUCKET" --region "$REGION" 2>/dev/null; then
  echo "Error: S3 bucket '$BUCKET' does not exist or is not accessible"
  exit 1
fi
echo "✓ S3 bucket exists and is accessible"
echo ""

# Deploy to S3
echo "Deploying to S3 bucket: $BUCKET"
echo "Sync options: $SYNC_OPTIONS"
echo ""

# Sync files to S3
aws s3 sync "$DIST_DIR/" "s3://$BUCKET/" \
  --region "$REGION" \
  --exclude "*.tmp" \
  --exclude "*.log" \
  --exclude ".*" \
  --cache-control "public, max-age=31536000" \
  --content-encoding "gzip" \
  $SYNC_OPTIONS

echo ""
echo "✓ Successfully deployed to S3 bucket: $BUCKET"

# Set proper content types for common files
echo ""
echo "Setting content types for common files..."

# Set content type for HTML files
aws s3 cp "s3://$BUCKET/" "s3://$BUCKET/" \
  --region "$REGION" \
  --recursive \
  --exclude "*" \
  --include "*.html" \
  --content-type "text/html" \
  --metadata-directive REPLACE \
  --cache-control "public, max-age=3600" \
  $([[ "$SYNC_OPTIONS" == *"--dry-run"* ]] && echo "--dry-run")

# Set content type for CSS files
aws s3 cp "s3://$BUCKET/" "s3://$BUCKET/" \
  --region "$REGION" \
  --recursive \
  --exclude "*" \
  --include "*.css" \
  --content-type "text/css" \
  --metadata-directive REPLACE \
  --cache-control "public, max-age=31536000" \
  $([[ "$SYNC_OPTIONS" == *"--dry-run"* ]] && echo "--dry-run")

# Set content type for JavaScript files
aws s3 cp "s3://$BUCKET/" "s3://$BUCKET/" \
  --region "$REGION" \
  --recursive \
  --exclude "*" \
  --include "*.js" \
  --content-type "application/javascript" \
  --metadata-directive REPLACE \
  --cache-control "public, max-age=31536000" \
  $([[ "$SYNC_OPTIONS" == *"--dry-run"* ]] && echo "--dry-run")

# Set content type for JSON files
aws s3 cp "s3://$BUCKET/" "s3://$BUCKET/" \
  --region "$REGION" \
  --recursive \
  --exclude "*" \
  --include "*.json" \
  --content-type "application/json" \
  --metadata-directive REPLACE \
  --cache-control "public, max-age=3600" \
  $([[ "$SYNC_OPTIONS" == *"--dry-run"* ]] && echo "--dry-run")

echo "✓ Content types set successfully"

# Invalidate CloudFront cache if distribution ID is provided
if [[ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]] && [[ "$PURGE_CLOUDFRONT" == "true" ]]; then
  echo ""
  echo "Creating CloudFront invalidation for distribution: $CLOUDFRONT_DISTRIBUTION_ID"
  
  invalidation_id=$(aws cloudfront create-invalidation \
    --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
    --paths "/*" \
    --query 'Invalidation.Id' \
    --output text \
    --region us-east-1 2>/dev/null)
  
  if [[ -n "$invalidation_id" ]]; then
    echo "✓ CloudFront invalidation created: $invalidation_id"
    echo "Waiting for invalidation to complete..."
    
    # Wait for invalidation to complete (with timeout)
    timeout=300
    start_time=$(date +%s)
    
    while true; do
      status=$(aws cloudfront get-invalidation \
        --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
        --id "$invalidation_id" \
        --query 'Invalidation.Status' \
        --output text \
        --region us-east-1 2>/dev/null)
      
      if [[ "$status" == "Completed" ]]; then
        echo "✓ CloudFront invalidation completed"
        break
      elif [[ "$status" == "Failed" ]]; then
        echo "✗ CloudFront invalidation failed"
        break
      fi
      
      # Check timeout
      current_time=$(date +%s)
      elapsed=$((current_time - start_time))
      if [[ $elapsed -gt $timeout ]]; then
        echo "⚠ CloudFront invalidation timeout (still in progress)"
        break
      fi
      
      sleep 5
    done
    
  else
    echo "✗ Failed to create CloudFront invalidation"
    exit 1
  fi
fi

# Generate deployment summary
echo ""
echo "=== AWS Deployment Summary ==="
echo "S3 Bucket: s3://$BUCKET/"
if [[ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]]; then
  echo "CloudFront Distribution: $CLOUDFRONT_DISTRIBUTION_ID"
  echo "CloudFront URL: https://$CLOUDFRONT_DISTRIBUTION_ID.cloudfront.net/"
fi
echo "AWS Region: $REGION"
echo "Completed at: $(date '+%Y-%m-%d %H:%M:%S')"

# List deployed files (if not dry-run)
if [[ "$SYNC_OPTIONS" != *"--dry-run"* ]]; then
  echo ""
  echo "Deployed files:"
  aws s3 ls "s3://$BUCKET/" --region "$REGION" --recursive --human-readable --summarize | tail -10
fi

echo ""
echo "=== AWS Deployment Completed ==="

# Return success
exit 0