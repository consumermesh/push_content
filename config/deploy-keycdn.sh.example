#!/bin/bash

# AWS S3 + CloudFront deployment script
# Usage: deploy-aws.sh -o <org> -n <name> --bucket <bucket> [--region <region>] [--cloudfront-distribution-id <distribution_id>]

set -e  # Exit on error
set -u  # Exit on undefined variable

# Default values
ORG=""
NAME=""
BUCKET=""
REGION="us-east-1"
CLOUDFRONT_DISTRIBUTION_ID=""
PURGE_CLOUDFRONT=true
SYNC_OPTIONS="--delete --exact-timestamps"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -o)
      ORG="$2"
      shift 2
      ;;
    -n)
      NAME="$2"
      shift 2
      ;;
    --bucket)
      BUCKET="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: $0 -o <org> -n <name>"
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Validate required parameters
if [[ -z "$ORG" ]] || [[ -z "$NAME" ]] || [[ -z "$BUCKET" ]]; then
  echo "Error: Missing required parameters"
  echo "Usage: $0 -o <org> -n <name> --bucket <bucket>"
  exit 1
fi

# Build paths
BUILD_DIR="/opt/cmesh/previews/$ORG-$NAME/fe/build"

# Check if build directory exists
if [[ ! -d "$BUILD_DIR" ]]; then
  echo "Error: Build directory not found: $BUILD_DIR"
  exit 1
fi

echo "Build directory: $BUILD_DIR"
echo ""

# Deploy to KeyCDN push zone
echo "Deploying to KeyCDN"
cd $BUILD_DIR
rsync -rtvz --chmod=D2755,F644 . spfoos@rsync.keycdn.com:$BUCKET/


echo ""
echo "âœ“ Successfully deployed to KeyCDN push zone: $BUCKET"

# Set proper content types for common files
echo ""
echo "Setting content types for common files..."

echo "=== KeyCDN Deployment Completed ==="

# Return success
exit 0
